---
layout:     post
title:      "网络是怎样连接的"
subtitle:   "图解趣味版"
date:       2020-04-06 10:39:00
author:     "aguozhang"
header-img: "img/post-bg-2015.jpg"
tags:
    - 网络 
    - 连接
    - TCP/IP
---

## 前言
买了有一段时间了，知道豆瓣上的评分很高而且是日本人写的图解趣味版，知道肯定是一本好书

今年因为公司的一些事，拖拖拉拉一本也没有翻开过

趁着清明节假期，一气呵成的看完，看完真是回味良久

相信每位程序员的家里都会有几本关于网络的大部头，看相信能看完的没几本，因为太他妈枯燥了。

那么这本书就是你需要的

## 摘录
* 包相当于信件或者包裹，而交换机和路由器则相当于邮局或快递公司的分拣处理区
* web浏览器
* 协议栈、网卡
* 集线器、交换机、路由器
* 接入网、网络运营商
* 防火墙、缓存服务器
* web服务器
* 互联网和公司内部的局域都是基于TCP/IP的思路来设计的
* 由一些小的子网，通过路由器连接起来组成一个大的网络
* 主机号 与 网络号
* ip地址的主机号：
* 全0：表示整个子网
* 全1：表示向子网上所有设备发送包，即“广播”
* dns 域名解析 resolver
* Socket库也是一种库
* Socket库是用于调用网络功能的程序组件集合
* 控制流程转移
* DNS服务器的基本工作： 域名 Class 类型
* 域名的层次结构，在域名中，越靠右的位置表示其层级越高
* 根域
* 13个
* 向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用Socket库中的程序组件
* 套接字
* 委托
* 创建套接字
* 识别出某个特定的套接字，这种方法就是描述符
* 应用程序是通过“描述符”这一类似号码牌的东西来识别套接字的
* 连接阶段：把管道接上去
* 描述符：应用程序用来识别套接字的机制
* IP地址和端口：客户端和服务器之间用于识别对方套接字的机制
* resolver
* ARP address resolution protocol 地址解析协议
* 套接字的实体就是通信控制信息
* 存放控制信息的内存空间就是套接字的实体
* 协议栈是根据套接字中记录的控制信息来工作的
* netstat -ano
* 创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态
* 连接实际上是通信双方交换控制信息，在套接字中记录这些必要信息并准备数据收发的一连串操作，像上面提到的客户端将IP地址和端口号告知服务器这样的过程就属于交换控制信息的一个具体的例子
* 缓冲区
* 头部是用于记录和交换控制信息的
* 通信操作中使用的控制信息分为两类：
* 头部中记录的信息
* 套接字（协议栈中的内存空间）中记录的信息
* syn比特设置为1
* 通过TCP头部中的发送方和接收方端口号可以找到要连接的套接字
* 协议栈并不关心应用程序传来的数据是什么内容
* MTU MSS
* MTU: 一个网络包的最大长度，以太网中一般为1500字节
* MSS: 除去头部之后，一个网络包所能容纳的TCP数据的最大长度
* 对较大的数据进行拆分
* 使用ACK号确认网络包已经收到
* 网卡、集线器、路由器都没有错误补偿机制，一旦检测到错误就直接丢弃相应的包
* 根据网络包平均往返时间调整ack号等待时间
* 使用窗口有效管理ack号
* 滑动窗口
* ack与窗口的合并
* 接收Http响应消息
* 断开连接
* Fin 设置为1
* 删除套接字
* 要等待几分钟之后再删除套接字
* 路由器根据目标地址判断下一个路由器的位置
* 集线器在子网中将网络包传输到下一个路由器
* 实际上，集线器是按照以太网规则传输包的设备，而路由器则是按照ip规则传输包的设备
* ip协议根据目标地址判断下一个ip转发设备的位置
* 子网中的以太网协议将包传输到下一个转发设备
* Mac头部
* ip头部
* ip模块负责添加如下两个头部：
* mac头部：以太网用的头部，包含mac地址
* ip头部： ip用的头部，包含ip地址
* 无论要收发的包是控制包还是数据包，ip对各种类型的包的收发操作都是相同的
* ip地址实际上并不是分配给计算机的，而是分配给网卡的
* ip头部的 接收方ip地址 填写通信对象的ip地址, 发送方ip地址需要判断发送所使用的网卡，并填写该网卡的ip地址
* ip表，路由表
* 目标地址和子网掩码都是0.0.0.0,这表示默认网关，如果其他所有条目都无法匹配，就会自动匹配这一行
* ip模块根据路由表Gateway栏的内容判断应该把包发送给谁
* 通过arp查询目标路由器的mac地址
* 查询mac地址需要使用arp
* 将ip包转换成电或光信号发送出去
* 网卡
* 网卡驱动程序会对硬件进行初始化操作，然后硬件才进入可以使用的状态
* 网卡的ROM中保存着全世界唯一的mac地址，这是在生产网卡时写入的
* 网卡中保存的mac地址会由网卡驱动程序读取并分配给mac模块
* 给网络包再加3个控制数据：报头 起始帧分界符 在末尾加上用于检测错误的FCS（帧校验序列）
* 向集线器发送网络包 半双工模式 全双工模式
* 网上的MAC模块生成通用信号，然后由PHY(MAC)模块转换成可在网线中传输的格式，并通过网线发送出去
* 接收返回包
* 通知计算机的操作会使用一个叫作中断的机制
* 中断处理程序会调用网卡驱动，控制网卡执行相应的接收操作
* 将服务器的响应包从ip传递给tcp
* ip模块会通过icmp消息将错误告知发送方
* 分片偏移量
* 分片重组
* 不需要重发的数据用udp发送更高效
* Socket 灯泡的插座
* 从网线到网络设备
* 每个包都是独立传输的
* 防止网线中的信号衰减很重要
* 拐角变圆
* 双绞 是为了抑制噪声
* 集线器将信号发往所有线路
* MDI-X则是交叉接线
* 交叉网线，就是一种将发送和接收信号线反过来接的网线
* 交换机的包转发操作
* 交换机端口的mac模块不具有mac地址
* 交换机根据mac地址表查找mac地址，然后将信号发送到相应的端口
* mac地址表的维护
* 全双工模式可以同时进行发送和接收
* 自动协商：确定最优的传输速率
* 交换机可同时执行多个转发操作
* 路由器包括转发模块和端口模块
* 转发模块负责判断包的转发目的地
* 端口模块负责包的收发操作
* 转发模块和端口模块的关系，就相当于协议栈的ip模块和网卡之间的关系
* 路由器的各个端口都具有mac地址和ip地址
* 路由器根据 ip地址 判断转发目标
* 路由器会忽略主机号，只匹配网络号
* 路由表的子网掩码列只表示在匹配网络包目标地址时需要对比的比特数量
* 路由协议机制
* 路由器的端口都具有mac地址，只接收与自身地址匹配的包，不匹配的直接丢弃
* 通过路由器转发的网络包，其接收方mac地址为路由器端口的mac地址
* 跃点计算越小说明该路由越近
* 路由表中子网掩码为0.0.0.0的记录表示 默认路由
* 包的有效期 TTL  每经过一个路由器就会减1
* 分片是对一个完整的包再进行拆分的过程
* icmp消息通知发送方
* 路由器判断下一个转发目标的方法如下：
* 如果路由表的网关列内容为ip地址，则该地址就是下一个转发目标
* 如果路由表的网关列内容为空，则ip头部中的接收方ip地址就是下一个转发目标
* 路由器也会使用arp来查询下一个转发目标的mac地址
* ip(路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机)来负责的
* 通过地址转换有效利用ip地址
* 地址转换
* hub 车轮的中心部分
* 通过接入网进入互联网内部
* 互联网的基本结构和家庭、公司网络是相同的
* 互联网接入路由器会在网络包前面加上mac头部、pppoe头部、ppp头部总共3种头部，然后发送给adsl modem(pppoe方式下）
* 正交振幅调制（QAM )
* adsl通过使用多个波来提高速率
* 分离器的作用
* bas会在包的前面加上隧道专用头部，并发送到隧道的出口
* 光纤的基本知识
* 单模
* 多模
* 通过光纤分路来降低成本
* pppoe是将ppp消息装入以太网包进行传输的方式
* pop 与 noc
* 网络包通过接入网之后，到达运营商pop的路由器
* 租借通信线路服务
* BGP 
* IX
* internet exchange 互联网交换中心
* bas也是路由器的一种
* 服务器端的局域网中有什么玄机
* 防火墙作用类似于海关
* 主流的包过滤方式
* 如何设置包过滤的规则
* 通过端口号限定应用程序
* 通过控制位判断连接方向
* 通过将请求平均分配给多台服务器来平衡负载
* 正向代理 反向代理 透明代理
* 利用内容分发服务分担负载
* 请求到达web服务器，响应返回浏览器
* 协议栈会给等待连接的套接字复制一个副本，然后将连接对象等控制信息写入新的套接字
* 使用描述符来指代套接字的原因如下：
* 1 等待连接的套接字中没有客户端ip地址和端口号
* 2 使用描述符这一种信息比较简单
* 网卡的mac模块将网络包从信号还原为数字信息，校验fcs并存入缓冲区
* 网卡驱动会根据mac头部判断协议类型，并将包交给相应的协议栈
* 协议栈的ip模块会检查ip头部 1 判断是不是发给自己的 2 判断网络包是否经过分片 3 将包转交给tcp模块或udp模块
* 如果收到的是发起连接的包，则tcp模块会 1 确认tcp头部的控制位syn 2 检查接收方端口号 3 为相应的等待连接套接字复制一个新的副本 4 记录发送方ip地址和端口号等信息
* 收到数据包时，tcp模块会 1 根据收到的包的发送方ip地址、发送方端口号、接收方ip地址、接收方端口号找到相对应的套接字 2 将数据块拼合起来并保存在接收缓冲区中 3 向客户端返回ACK
* gateway 像门一样的入口




